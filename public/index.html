<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude-like App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #fff;
            padding: 1rem;
            border-bottom: 1px solid #e1e1e1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            text-align: center;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid #e1e1e1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .pdf-upload {
            margin-bottom: 1rem;
        }

        .upload-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .upload-btn:hover {
            background-color: #0056b3;
        }

        .report-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .report-btn:hover {
            background-color: #218838;
        }

        .report-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .report-actions {
            margin-top: 1rem;
            display: none;
        }

        .report-type-selector {
            margin-bottom: 1rem;
        }

        .report-type-selector label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
        }

        .report-type-dropdown {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .report-type-dropdown:focus {
            outline: none;
            border-color: #007bff;
        }

        .pdf-info {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #666;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.user {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background-color: #f1f3f5;
            color: #333;
        }

        .chat-input {
            border-top: 1px solid #e1e1e1;
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: #007bff;
        }

        .send-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .send-btn:hover {
            background-color: #0056b3;
        }

        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #666;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Claude-like avec Support PDF</h1>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="pdf-upload">
                <input type="file" id="pdf-file" accept=".pdf" style="display: none;">
                <button class="upload-btn" onclick="document.getElementById('pdf-file').click()">
                    üìÑ T√©l√©charger un PDF
                </button>
                <div id="pdf-info" class="pdf-info" style="display: none;"></div>

                <div id="report-actions" class="report-actions">
                    <div class="report-type-selector">
                        <label for="report-type">Type de rapport :</label>
                        <select id="report-type" class="report-type-dropdown">
                            <option value="intervention">üîß Rapport d'Intervention</option>
                            <option value="academique">üìö Rapport Acad√©mique</option>
                            <option value="executif">üíº Rapport Ex√©cutif</option>
                        </select>
                    </div>
                    <button class="report-btn" id="generate-report-btn" onclick="generateReport()">
                        üìä G√©n√©rer Rapport Pro
                    </button>
                    <button class="report-btn" id="convert-presentation-btn" onclick="convertToPresentation()" style="display: none; background-color: #28a745;">
                        üéØ Convertir en Pr√©sentation
                    </button>
                    <button class="report-btn" id="download-report-btn" onclick="downloadReport()" style="display: none; background-color: #17a2b8;">
                        üíæ T√©l√©charger Rapport
                    </button>
                    <button class="report-btn" id="download-presentation-btn" onclick="downloadPresentation()" style="display: none; background-color: #6f42c1;">
                        üéûÔ∏è T√©l√©charger Pr√©sentation
                    </button>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">
                    Bonjour ! Je suis votre assistant Claude-like. Vous pouvez me poser des questions ou t√©l√©charger un PDF pour que je l'analyse.
                </div>
            </div>

            <div class="loading" id="loading">
                ‚è≥ R√©flexion en cours...
            </div>

            <div class="chat-input">
                <input type="text" id="message-input" placeholder="Tapez votre message..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" id="send-btn" onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <script>
        let pdfContent = null;
        let reportHtml = null;
        let reportFileName = null;
        let analysisData = null;
        let presentationHtml = null;
        let presentationFileName = null;

        document.getElementById('pdf-file').addEventListener('change', uploadPDF);

        async function uploadPDF() {
            const fileInput = document.getElementById('pdf-file');
            const file = fileInput.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('pdf', file);

            try {
                const response = await fetch('/api/upload-pdf', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    pdfContent = data.text;
                    document.getElementById('pdf-info').innerHTML = `
                        <strong>PDF charg√©:</strong> ${file.name}<br>
                        <strong>Pages:</strong> ${data.pages}<br>
                        <strong>Caract√®res:</strong> ${data.text.length}
                    `;
                    document.getElementById('pdf-info').style.display = 'block';

                    addMessage('PDF t√©l√©charg√© avec succ√®s ! Vous pouvez maintenant me poser des questions √† son sujet ou g√©n√©rer un rapport professionnel.', 'assistant');
                    document.getElementById('report-actions').style.display = 'block';
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Erreur lors du t√©l√©chargement du PDF');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            const sendBtn = document.getElementById('send-btn');
            const loading = document.getElementById('loading');

            sendBtn.disabled = true;
            loading.style.display = 'block';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        pdfContent: pdfContent
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage(data.response, 'assistant');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Erreur de communication avec le serveur');
            } finally {
                sendBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showError(errorMessage) {
            const messagesContainer = document.getElementById('chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = errorMessage;
            messagesContainer.appendChild(errorDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function generateReport() {
            if (!pdfContent) {
                showError('Aucun PDF charg√© pour g√©n√©rer un rapport');
                return;
            }

            const generateBtn = document.getElementById('generate-report-btn');
            const loading = document.getElementById('loading');
            const reportType = document.getElementById('report-type').value;

            generateBtn.disabled = true;
            loading.style.display = 'block';

            try {
                // PHASE 1: Analyse du PDF
                generateBtn.textContent = '‚è≥ Phase 1/4 - Analyse...';
                addMessage('üîç PHASE 1: Analyse et structuration du document PDF...', 'assistant');

                const phase1Response = await fetch('/api/analyze-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pdfContent: pdfContent })
                });

                const phase1Data = await phase1Response.json();

                if (!phase1Response.ok) {
                    throw new Error(phase1Data.error || 'Erreur Phase 1');
                }

                analysisData = phase1Data.analysis;
                addMessage('‚úÖ Phase 1 termin√©e: Analyse du contenu effectu√©e', 'assistant');

                // PHASE 2: G√©n√©ration du rapport
                generateBtn.textContent = '‚è≥ Phase 2/4 - G√©n√©ration...';
                addMessage('üîß PHASE 2: G√©n√©ration du rapport professionnel...', 'assistant');

                const phase2Response = await fetch('/api/generate-report-structure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        analysis: analysisData,
                        fileName: document.getElementById('pdf-file').files[0].name.replace('.pdf', ''),
                        reportType: reportType
                    })
                });

                let phase2Data;
                const contentType = phase2Response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    phase2Data = await phase2Response.json();
                } else {
                    const text = await phase2Response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error(`Erreur serveur (${phase2Response.status}): ${text.substring(0, 100)}`);
                }

                if (!phase2Response.ok) {
                    throw new Error(phase2Data.error || 'Erreur Phase 2');
                }

                addMessage('‚úÖ Phase 2 termin√©e: Rapport HTML g√©n√©r√© avec succ√®s', 'assistant');

                // PHASE 3: Finalisation
                generateBtn.textContent = '‚è≥ Phase 3/4 - Finalisation...';
                addMessage('üéØ PHASE 3: Finalisation et pr√©paration du t√©l√©chargement...', 'assistant');

                const phase3Response = await fetch('/api/finalize-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reportHtml: phase2Data.reportHtml,
                        fileName: phase2Data.fileName
                    })
                });

                const phase3Data = await phase3Response.json();

                if (!phase3Response.ok) {
                    throw new Error(phase3Data.error || 'Erreur Phase 3');
                }

                // Success !
                reportHtml = phase3Data.reportHtml;
                reportFileName = phase3Data.fileName;

                addMessage('‚úÖ Phase 3 termin√©e: Rapport finalis√©', 'assistant');
                addMessage(`üìä Rapport g√©n√©r√© (${(phase3Data.size / 1000).toFixed(1)}kb)`, 'assistant');
                addMessage('üí° Cliquez sur "Convertir en Pr√©sentation" pour la Phase 4 !', 'assistant');

                document.getElementById('download-report-btn').style.display = 'block';
                document.getElementById('convert-presentation-btn').style.display = 'block';
                generateBtn.textContent = '‚úÖ Rapport G√©n√©r√© (3/4)';

            } catch (error) {
                console.error('Erreur:', error);

                if (error.message.includes('surcharg√©e') || error.message.includes('503')) {
                    showError('üö® API surcharg√©e d√©tect√©e. Tentative automatique dans les phases suivantes.');
                    generateBtn.textContent = 'üîÑ R√©essayer dans 3 min';
                    setTimeout(() => {
                        generateBtn.textContent = 'üìä G√©n√©rer Rapport Pro';
                    }, 180000);
                } else {
                    showError('‚ùå ' + error.message);
                    generateBtn.textContent = 'üìä G√©n√©rer Rapport Pro';
                }
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function downloadReport() {
            if (!reportHtml) {
                showError('Aucun rapport √† t√©l√©charger');
                return;
            }

            const blob = new Blob([reportHtml], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = reportFileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addMessage('üíæ Rapport t√©l√©charg√© avec succ√®s !', 'assistant');
        }

        async function convertToPresentation() {
            if (!reportHtml) {
                showError('Aucun rapport g√©n√©r√© pour conversion');
                return;
            }

            const convertBtn = document.getElementById('convert-presentation-btn');
            const loading = document.getElementById('loading');
            const reportType = document.getElementById('report-type').value;

            convertBtn.disabled = true;
            loading.style.display = 'block';

            try {
                convertBtn.textContent = '‚è≥ Phase 4/4 - Conversion...';
                addMessage('üéØ PHASE 4: Conversion en format Pr√©sentation interactive...', 'assistant');

                const phase4Response = await fetch('/api/convert-to-presentation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reportHtml: reportHtml,
                        fileName: reportFileName,
                        reportType: reportType
                    })
                });

                let phase4Data;
                try {
                    phase4Data = await phase4Response.json();
                } catch (jsonError) {
                    console.error('Erreur parsing JSON Phase 4:', jsonError);
                    throw new Error('R√©ponse serveur invalide - R√©essayez dans quelques secondes');
                }

                if (!phase4Response.ok) {
                    throw new Error(phase4Data.error || 'Erreur Phase 4');
                }

                // Success !
                presentationHtml = phase4Data.presentationHtml;
                presentationFileName = phase4Data.fileName;

                addMessage('‚úÖ Phase 4 termin√©e: Pr√©sentation interactive cr√©√©e !', 'assistant');
                addMessage(`üéûÔ∏è Pr√©sentation g√©n√©r√©e (${(phase4Data.size / 1000).toFixed(1)}kb)`, 'assistant');
                addMessage('üéØ Navigation: Fl√®ches ‚Üê ‚Üí ou clavier, points indicateurs inclus', 'assistant');

                document.getElementById('download-presentation-btn').style.display = 'block';
                convertBtn.textContent = '‚úÖ Pr√©sentation Cr√©√©e (4/4)';

            } catch (error) {
                console.error('Erreur Phase 4:', error);
                showError('‚ùå ' + error.message);
                convertBtn.textContent = 'üéØ Convertir en Pr√©sentation';
            } finally {
                convertBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function downloadPresentation() {
            if (!presentationHtml) {
                showError('Aucune pr√©sentation √† t√©l√©charger');
                return;
            }

            const blob = new Blob([presentationHtml], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = presentationFileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addMessage('üéûÔ∏è Pr√©sentation t√©l√©charg√©e avec succ√®s ! Ouvrez le fichier HTML dans votre navigateur.', 'assistant');
        }
    </script>
</body>
</html>