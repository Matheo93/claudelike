<!-- üî• CHAT EDITOR ADDON - Add this to your index.html -->

<!-- ADD THIS CSS in <style> section -->
<style>
/* Chat Button (Fixed bottom-right) */
#chat-toggle-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.3s ease;
}

#chat-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
}

/* Chat Panel (Slide-in from right) */
#chat-panel {
    position: fixed;
    top: 0;
    right: -450px;
    width: 450px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 20px rgba(0,0,0,0.15);
    z-index: 9998;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}

#chat-panel.open {
    right: 0;
}

/* Chat Header */
#chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#chat-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

#chat-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
}

#chat-close:hover {
    opacity: 1;
}

/* Chat Messages */
#chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.chat-message {
    margin-bottom: 16px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-message.user {
    text-align: right;
}

.chat-message .bubble {
    display: inline-block;
    padding: 12px 16px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
}

.chat-message.user .bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.chat-message.assistant .bubble {
    background: white;
    color: #333;
    border: 1px solid #e1e8ed;
}

.chat-message.system .bubble {
    background: #e8f5e9;
    color: #2e7d32;
    font-size: 0.9rem;
}

/* Typing Indicator */
#typing-indicator {
    display: none;
    padding: 12px;
    background: white;
    border-radius: 18px;
    max-width: 80px;
}

#typing-indicator.active {
    display: inline-block;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #999;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

/* Chat Input */
#chat-input-area {
    padding: 16px;
    background: white;
    border-top: 1px solid #e1e8ed;
}

#chat-input-area textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    resize: none;
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}

#chat-input-area textarea:focus {
    border-color: #667eea;
}

#chat-send-btn {
    margin-top: 8px;
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: opacity 0.2s;
}

#chat-send-btn:hover:not(:disabled) {
    opacity: 0.9;
}

#chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Quick Actions */
.quick-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.quick-action {
    padding: 6px 12px;
    background: #f0f0f0;
    border: 1px solid #d0d0d0;
    border-radius: 16px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.quick-action:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}
</style>

<!-- ADD THIS HTML at the end of <body> (before </body>) -->

<!-- Chat Toggle Button -->
<button id="chat-toggle-btn" title="Edit Report with AI">üí¨</button>

<!-- Chat Panel -->
<div id="chat-panel">
    <div id="chat-header">
        <h3>‚ú® Report Editor</h3>
        <button id="chat-close">√ó</button>
    </div>

    <div id="chat-messages">
        <div class="chat-message assistant">
            <div class="bubble">
                Hi! I can help you modify your report. Try:
                <br>‚Ä¢ "Change colors to blue"
                <br>‚Ä¢ "Add a risks section"
                <br>‚Ä¢ "Make section 2 longer"
            </div>
        </div>
    </div>

    <div id="chat-input-area">
        <textarea id="chat-input" placeholder="Ask me to modify the report..." rows="3"></textarea>
        <div class="quick-actions">
            <button class="quick-action" onclick="quickAction('Change colors to emerald green')">üé® Change colors</button>
            <button class="quick-action" onclick="quickAction('Add a new section about risks')">‚ûï Add section</button>
            <button class="quick-action" onclick="quickAction('Make the first section more detailed')">üìù Expand section</button>
        </div>
        <button id="chat-send-btn">Send</button>
    </div>
</div>

<!-- ADD THIS JAVASCRIPT at the end of <script> section -->
<script>
// üî• CHAT FUNCTIONALITY

let currentReportHtml = '';
let currentPdfText = '';
let chatOpen = false;

// Toggle chat panel
document.getElementById('chat-toggle-btn').addEventListener('click', () => {
    chatOpen = !chatOpen;
    document.getElementById('chat-panel').classList.toggle('open', chatOpen);
});

document.getElementById('chat-close').addEventListener('click', () => {
    chatOpen = false;
    document.getElementById('chat-panel').classList.remove('open');
});

// Send message on button click
document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);

// Send message on Enter (Shift+Enter for new line)
document.getElementById('chat-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
    }
});

// Quick action shortcut
function quickAction(message) {
    document.getElementById('chat-input').value = message;
    sendChatMessage();
}

// Main send function
async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message) return;

    // Check if report exists
    const reportContainer = document.getElementById('report-content') || document.getElementById('main-content');
    if (!reportContainer || !reportContainer.innerHTML.trim()) {
        addChatMessage('system', '‚ö†Ô∏è Please generate a report first before using the chat editor.');
        return;
    }

    // Get current report HTML
    currentReportHtml = reportContainer.innerHTML;

    // Clear input
    input.value = '';

    // Add user message
    addChatMessage('user', message);

    // Show typing indicator
    showTypingIndicator();

    // Disable send button
    const sendBtn = document.getElementById('chat-send-btn');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Processing...';

    try {
        const response = await fetch('/api/chat-edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                reportHtml: currentReportHtml,
                pdfText: currentPdfText
            })
        });

        const result = await response.json();

        hideTypingIndicator();

        if (!response.ok) {
            throw new Error(result.error || 'Server error');
        }

        if (result.type === 'text_response') {
            // Just a text answer
            addChatMessage('assistant', result.message);
        } else if (result.type === 'report_update') {
            // Report was modified
            const change = result.changes[0]; // Take first change

            if (change.instant) {
                // Instant CSS change
                reportContainer.innerHTML = change.newHtml;
                addChatMessage('system', '‚úÖ ' + result.message + ' (instant)');
            } else {
                // Animated update
                reportContainer.style.opacity = '0.5';
                reportContainer.style.transition = 'opacity 0.3s';

                setTimeout(() => {
                    reportContainer.innerHTML = change.newHtml;
                    reportContainer.style.opacity = '1';
                    addChatMessage('system', '‚úÖ ' + result.message);
                }, 300);
            }

            // Update stored HTML
            currentReportHtml = change.newHtml;
        } else if (result.type === 'error') {
            addChatMessage('assistant', '‚ùå ' + result.message);
        }

    } catch (error) {
        hideTypingIndicator();
        console.error('Chat error:', error);
        addChatMessage('assistant', '‚ùå Error: ' + error.message);
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
    }
}

// Add message to chat
function addChatMessage(role, text) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    messageDiv.innerHTML = `<div class="bubble">${text}</div>`;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Typing indicator
function showTypingIndicator() {
    const messagesContainer = document.getElementById('chat-messages');
    const indicator = document.createElement('div');
    indicator.id = 'typing-indicator';
    indicator.className = 'chat-message assistant active';
    indicator.innerHTML = `
        <div class="bubble">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    messagesContainer.appendChild(indicator);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
}

// Store PDF text when uploaded (add this to your existing PDF upload handler)
// IMPORTANT: In your existing generateReport() function, add this line:
// currentPdfText = pdfText; // Store for chat context

console.log('‚úÖ Chat editor loaded');
</script>
