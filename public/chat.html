<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocGenius - AI Report Generator</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="apple-touch-icon" href="/logo.svg">

    <!-- SEO Meta Tags -->
    <meta name="description" content="Generate professional AI-powered reports from your PDFs. Interactive chat, advanced analysis, beautiful visualizations.">
    <meta name="theme-color" content="#6366f1">
    <meta name="robots" content="noindex, nofollow">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #14b8a6;
            --dark: #0a0a0f;
            --dark-light: #15151f;
            --dark-lighter: #1e1e2e;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            background: var(--dark);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(at 20% 30%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 70%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                linear-gradient(180deg, var(--dark) 0%, var(--dark-light) 100%);
            z-index: -1;
            animation: meshMove 20s ease infinite;
        }

        @keyframes meshMove {
            0%, 100% {
                background-position: 0% 0%, 100% 100%;
                filter: hue-rotate(0deg);
            }
            50% {
                background-position: 100% 100%, 0% 0%;
                filter: hue-rotate(20deg);
            }
        }

        /* Header */
        .header {
            position: relative;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
            padding: 1.5rem 2rem;
            overflow: visible;
            z-index: 10002;
        }

        .header h1 {
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientFlow 3s ease infinite;
            font-size: 1.8rem;
            font-weight: 800;
            text-align: center;
            letter-spacing: -0.5px;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Chat History Menu */
        .chat-menu {
            position: absolute;
            left: 2rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 10001;
        }

        .chat-menu-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 0.625rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-menu-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }

        .chat-menu-dropdown {
            position: fixed;
            top: 6rem;
            left: 2rem;
            min-width: 300px;
            max-width: 400px;
            background: var(--dark-lighter);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1rem;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 10000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .chat-menu-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .chat-menu-dropdown::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-menu-dropdown::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .chat-menu-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-menu-dropdown.show {
            display: flex;
        }

        .chat-menu-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chat-menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .chat-menu-item.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.15);
        }

        .chat-menu-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
        }

        .chat-menu-item-date {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-menu-new {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            font-weight: 600;
        }

        .chat-menu-new:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .chat-menu-delete {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .chat-menu-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Profile Menu (right side) */
        .profile-menu {
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 10001;
        }

        .profile-menu-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 0.625rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .profile-menu-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }

        .profile-menu-dropdown {
            position: fixed;
            min-width: 280px;
            background: var(--dark-lighter);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1rem;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .profile-menu-dropdown.show {
            display: flex;
        }

        .profile-menu-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
        }

        .profile-menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .profile-menu-item.danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .profile-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .profile-menu-divider {
            height: 1px;
            background: var(--glass-border);
            margin: 0.5rem 0;
        }

        /* Main Container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 1.5rem;
            padding: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            width: 420px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        /* Section Styling */
        .section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.5rem;
        }

        /* Upload Area */
        .upload-area {
            position: relative;
            border: 2px dashed var(--glass-border);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.has-file {
            border-color: var(--accent);
            background: rgba(20, 184, 166, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .pdf-info {
            background: rgba(20, 184, 166, 0.1);
            border: 1px solid rgba(20, 184, 166, 0.3);
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Dropdown Styling */
        .dropdown-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .dropdown-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .dropdown {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 3rem;
        }

        .dropdown:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Fix dropdown options visibility */
        .dropdown option {
            background: var(--dark-lighter);
            color: white;
            padding: 0.5rem;
        }

        /* Button Styling */
        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:disabled:hover {
            transform: none;
        }

        /* Primary Button */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        /* Secondary Button */
        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Accent Buttons */
        .btn-accent {
            background: linear-gradient(135deg, var(--accent), #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4);
        }

        .btn-accent:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }

        .btn-info {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }

        .btn-info:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.6);
        }

        /* Action Groups */
        .action-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .action-row {
            display: flex;
            gap: 0.75rem;
        }

        .action-row .btn {
            flex: 1;
        }

        /* History Controls */
        .history-controls {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem;
        }

        .history-info {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.5rem;
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        /* Messages */
        .message {
            padding: 1rem 1.25rem;
            border-radius: 16px;
            max-width: 75%;
            line-height: 1.6;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-left: auto;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .message.assistant {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: rgba(255, 255, 255, 0.9);
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            padding: 1rem;
            border-radius: 12px;
            max-width: 100%;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            animation: pulse 1.5s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat Input */
        .chat-input {
            border-top: 1px solid var(--glass-border);
            padding: 1.5rem 2rem;
            display: flex;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.02);
        }

        .chat-input input {
            flex: 1;
            padding: 0.875rem 1.25rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Divider */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-border), transparent);
            margin: 1rem 0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 360px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- Chat History Menu -->
        <div class="chat-menu">
            <button class="chat-menu-btn" onclick="toggleChatMenu()">
                💬 <span id="current-chat-name">Current Chat</span> ▾
            </button>
            <div class="chat-menu-dropdown" id="chat-menu-dropdown">
                <!-- Chats will be loaded here -->
            </div>
        </div>

        <h1>DocGenius</h1>

        <!-- Profile Menu -->
        <div class="profile-menu">
            <button class="profile-menu-btn" onclick="toggleProfileMenu()">
                👤 <span id="user-email">Profile</span> ▾
            </button>
            <div class="profile-menu-dropdown" id="profile-menu-dropdown">
                <div class="profile-menu-item" onclick="showRecoverReportDialog()">
                    🔄 Recover Report
                </div>
                <div class="profile-menu-divider"></div>
                <div class="profile-menu-item" onclick="showAccountInfo()">
                    👤 Account Info
                </div>
                <div class="profile-menu-item" onclick="showBilling()">
                    💳 Billing & Support
                </div>
                <div class="profile-menu-item" onclick="showSettings()">
                    ⚙️ Settings
                </div>
                <div class="profile-menu-divider"></div>
                <div class="profile-menu-item" onclick="logout()">
                    🚪 Logout
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Step 1: Upload -->
            <div class="section">
                <div class="section-title">📄 Step 1: Upload PDF</div>
                <input type="file" id="pdf-file" accept=".pdf" style="display: none;">
                <div class="upload-area" onclick="document.getElementById('pdf-file').click()">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">Click to upload PDF</div>
                    <div class="upload-subtext">or drag and drop</div>
                </div>
                <div id="pdf-info" class="pdf-info" style="display: none;"></div>
            </div>

            <!-- Step 2: Configure (shown after upload) -->
            <div id="config-section" class="section" style="display: none;">
                <div class="section-title">⚙️ Step 2: Configure</div>

                <div class="dropdown-group">
                    <label class="dropdown-label" for="report-type">Report Type</label>
                    <select id="report-type" class="dropdown">
                        <option value="academique">📚 Report Enhanced</option>
                        <option value="professional">💼 Professional</option>
                    </select>
                </div>

                <div class="dropdown-group">
                    <label class="dropdown-label" for="ai-model">AI Model</label>
                    <select id="ai-model" class="dropdown">
                        <option value="deepseek">🤖 DeepSeek AI</option>
                    </select>
                </div>
            </div>

            <!-- Step 3: Generate -->
            <div id="generate-section" class="section" style="display: none;">
                <div class="section-title">🎯 Step 3: Generate</div>
                <button class="btn btn-primary" id="generate-report-btn" onclick="generateReport()">
                    📊 Generate Report
                </button>
            </div>

            <div class="divider" id="actions-divider" style="display: none;"></div>

            <!-- Step 4: Post-Generation Actions (shown after generation) -->
            <div id="actions-section" class="section" style="display: none;">
                <div class="section-title">✨ Step 4: Actions</div>

                <div class="action-group">
                    <div class="action-row">
                        <button class="btn btn-secondary" id="preview-btn" onclick="previewReport()">
                            👁️ Preview
                        </button>
                        <button class="btn btn-info" id="download-report-btn" onclick="downloadReport()">
                            💾 Download
                        </button>
                    </div>

                    <button class="btn btn-accent" id="convert-presentation-btn" onclick="convertToPresentation()">
                        🎯 Convert to Presentation
                    </button>

                    <button class="btn btn-accent" id="download-presentation-btn" onclick="downloadPresentation()" style="display: none;">
                        🎞️ Download Presentation
                    </button>

                    <button class="btn btn-secondary" id="view-docs-btn" onclick="showCommandsDocumentation()">
                        📚 View Documentation
                    </button>
                </div>

                <!-- Undo/Redo Controls -->
                <div id="history-controls" class="history-controls" style="display: none;">
                    <div class="action-row">
                        <button id="undo-btn" onclick="undo()" class="btn btn-secondary" disabled>
                            ⏪ Undo
                        </button>
                        <button id="redo-btn" onclick="redo()" class="btn btn-secondary" disabled>
                            ⏩ Redo
                        </button>
                    </div>
                    <div class="history-info">
                        History: <span id="history-info">0/0</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">
                    Hello! I'm DocGenius, your AI assistant. Upload a PDF to generate a professional report.
                </div>
            </div>

            <div class="loading" id="loading">
                ⏳ Réflexion en cours...
            </div>

            <div class="chat-input">
                <input type="text" id="message-input" placeholder="Tapez votre message..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" id="send-btn" onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <script>
        // 🔐 Initialize Supabase
        const SUPABASE_URL = 'https://cvyurlzfzgslthtqxpeq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2eXVybHpmemdzbHRodHF4cGVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMjk2MjAsImV4cCI6MjA3NTkwNTYyMH0.xjlFbQ5iH-sekLOQirfX4ACW_QGGesfGTF_p7-1sDHQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 👤 Current user data
        let currentUser = null;

        // 💾 CHAT HISTORY SYSTEM
        let currentChatId = null;
        let chats = {};

        let pdfContent = null;
        let reportHtml = null;
        let reportFileName = null;
        let analysisData = null;
        let enhancedHtml = null;
        let enhancedFileName = null;
        let presentationHtml = null;
        let presentationFileName = null;

        // Check authentication and load user
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = '/auth';
                return;
            }

            currentUser = session.user;

            // Update profile button with user email
            const userEmailEl = document.getElementById('user-email');
            if (userEmailEl && currentUser.email) {
                const emailShort = currentUser.email.length > 15
                    ? currentUser.email.substring(0, 12) + '...'
                    : currentUser.email;
                userEmailEl.textContent = emailShort;
            }
        }

        // Call auth check immediately
        checkAuth();

        // Save chats to localStorage (simple version for async updates)
        function saveChatsToStorage() {
            localStorage.setItem('docgenius_chats', JSON.stringify(chats));
        }

        // Initialize chat history from localStorage
        function initChatHistory() {
            const savedChats = localStorage.getItem('docgenius_chats');
            if (savedChats) {
                chats = JSON.parse(savedChats);
            }

            // Load last active chat or create new one
            const lastChatId = localStorage.getItem('docgenius_last_chat');
            if (lastChatId && chats[lastChatId]) {
                loadChat(lastChatId);
            } else {
                startNewChat();
            }

            updateChatMenu();
        }

        // Start a new chat
        function startNewChat(skipSave = false) {
            currentChatId = Date.now().toString();
            chats[currentChatId] = {
                id: currentChatId,
                name: `Chat ${Object.keys(chats).length + 1}`,
                date: new Date().toISOString(),
                messages: [],
                pdfContent: null,
                pdfFileName: null,
                reportHtml: null,
                reportFileName: null
            };

            // Clear current state
            pdfContent = null;
            reportHtml = null;
            reportFileName = null;
            document.getElementById('chat-messages').innerHTML = `
                <div class="message assistant">
                    Hello! I'm DocGenius, your AI assistant. Upload a PDF to generate a professional report.
                </div>
            `;

            // Reset UI
            document.getElementById('config-section').style.display = 'none';
            document.getElementById('generate-section').style.display = 'none';
            document.getElementById('actions-section').style.display = 'none';
            document.querySelector('.upload-area').classList.remove('has-file');
            document.getElementById('pdf-info').style.display = 'none';

            if (!skipSave) {
                saveChats();
            }
            updateChatMenu();
            updateCurrentChatName();
        }

        // Load a specific chat
        function loadChat(chatId) {
            if (!chats[chatId]) return;

            currentChatId = chatId;
            const chat = chats[chatId];

            // Restore state
            pdfContent = chat.pdfContent;
            reportHtml = chat.reportHtml;
            reportFileName = chat.reportFileName;

            // Restore messages
            document.getElementById('chat-messages').innerHTML = '';
            chat.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}`;
                messageDiv.textContent = msg.text;
                document.getElementById('chat-messages').appendChild(messageDiv);
            });

            // Reset ALL UI sections first
            document.querySelector('.upload-area').classList.remove('has-file');
            document.getElementById('pdf-info').style.display = 'none';
            document.getElementById('config-section').style.display = 'none';
            document.getElementById('generate-section').style.display = 'none';
            document.getElementById('actions-section').style.display = 'none';
            document.getElementById('actions-divider').style.display = 'none';

            // Restore UI state based on chat data
            if (chat.pdfFileName) {
                document.querySelector('.upload-area').classList.add('has-file');
                document.getElementById('pdf-info').innerHTML = `<strong>✓ ${chat.pdfFileName}</strong>`;
                document.getElementById('pdf-info').style.display = 'block';
                document.getElementById('config-section').style.display = 'flex';
                document.getElementById('generate-section').style.display = 'flex';
            }

            // ONLY show actions if report exists
            if (chat.reportHtml) {
                document.getElementById('actions-section').style.display = 'flex';
                document.getElementById('actions-divider').style.display = 'block';
            }

            // 🔄 Check for pending job and resume polling
            if (chat.jobId && chat.jobType) {
                console.log(`🔄 Resuming job ${chat.jobId} (${chat.jobType})`);
                addMessage(`🔄 Resuming ${chat.jobType} report generation...`, 'assistant');

                const generateBtn = document.getElementById('generate-report-btn');
                generateBtn.textContent = '⏳ Resuming generation...';
                generateBtn.disabled = true;

                // Resume polling based on job type
                if (chat.jobType === 'professional') {
                    pollReportStatus(chat.jobId, generateBtn).catch(err => {
                        console.error('Resume polling error:', err);
                        generateBtn.disabled = false;
                    });
                } else if (chat.jobType === 'enhanced') {
                    pollEnhancedReportStatus(chat.jobId, generateBtn).catch(err => {
                        console.error('Resume polling error:', err);
                        generateBtn.disabled = false;
                    });
                }
            }

            localStorage.setItem('docgenius_last_chat', chatId);
            updateCurrentChatName();
            closeChatMenu();
        }

        // Delete a chat
        function deleteChat(chatId, event) {
            console.log('🗑️ DELETE CHAT CALLED:', {
                chatId,
                currentChatId,
                isCurrent: currentChatId === chatId,
                event
            });

            event.stopPropagation();
            event.preventDefault();

            if (!confirm('Delete this chat?')) {
                console.log('❌ Delete cancelled by user');
                return;
            }

            console.log('✅ Delete confirmed, proceeding...');

            // If deleting current chat, load another chat FIRST, then delete
            if (currentChatId === chatId) {
                console.log('🔄 Deleting CURRENT chat');

                // Get all chats BEFORE deleting
                const allChats = Object.values(chats).sort((a, b) => new Date(b.date) - new Date(a.date));

                // Find other chats (excluding current)
                const otherChats = allChats.filter(chat => chat.id !== chatId);

                // Close menu first
                closeChatMenu();

                if (otherChats.length > 0) {
                    // Load the most recent OTHER chat FIRST
                    console.log('📂 Loading most recent other chat:', otherChats[0].id);
                    loadChat(otherChats[0].id);

                    // NOW delete the old chat
                    console.log('🗑️ Now deleting chat:', chatId);
                    delete chats[chatId];
                    localStorage.setItem('docgenius_chats', JSON.stringify(chats));
                    console.log('💾 Chat deleted from storage');

                    // Update menu to reflect deletion
                    updateChatMenu();
                } else {
                    // No other chats, delete current and create new one
                    console.log('✨ No other chats, deleting and creating new one...');
                    delete chats[chatId];
                    localStorage.setItem('docgenius_chats', JSON.stringify(chats));
                    console.log('💾 Chat deleted from storage');

                    startNewChat();
                }
            } else {
                console.log('📋 Deleting non-current chat, updating menu only');
                // Delete from storage
                delete chats[chatId];
                saveChats();
                // Just update menu for non-current chats
                updateChatMenu();
            }
        }

        // Save chats to localStorage
        function saveChats() {
            // Update current chat with latest data
            if (currentChatId && chats[currentChatId]) {
                chats[currentChatId].pdfContent = pdfContent;
                chats[currentChatId].reportHtml = reportHtml;
                chats[currentChatId].reportFileName = reportFileName;
                chats[currentChatId].pdfFileName = document.getElementById('pdf-file').files[0]?.name || chats[currentChatId].pdfFileName;

                // Save messages
                const messages = [];
                document.querySelectorAll('#chat-messages .message').forEach(msg => {
                    messages.push({
                        text: msg.textContent,
                        sender: msg.classList.contains('user') ? 'user' : 'assistant'
                    });
                });
                chats[currentChatId].messages = messages;
            }

            localStorage.setItem('docgenius_chats', JSON.stringify(chats));
        }

        // Update chat menu UI
        function updateChatMenu() {
            const dropdown = document.getElementById('chat-menu-dropdown');
            const chatList = Object.values(chats).sort((a, b) => new Date(b.date) - new Date(a.date));

            // Clear dropdown
            dropdown.innerHTML = '';

            // Add "Start New Chat" button
            const newChatBtn = document.createElement('div');
            newChatBtn.className = 'chat-menu-item chat-menu-new';
            newChatBtn.textContent = '➕ Start New Chat';
            newChatBtn.onclick = (e) => {
                e.stopPropagation();
                closeChatMenu();
                startNewChat();
            };
            dropdown.appendChild(newChatBtn);

            // Add divider
            const divider = document.createElement('div');
            divider.style.cssText = 'height: 1px; background: var(--glass-border); margin: 0.5rem 0;';
            dropdown.appendChild(divider);

            // Add chat items
            chatList.forEach(chat => {
                const date = new Date(chat.date).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const item = document.createElement('div');
                item.className = `chat-menu-item ${chat.id === currentChatId ? 'active' : ''}`;

                // Create title and date div
                const titleDiv = document.createElement('div');
                titleDiv.className = 'chat-menu-item-title';
                titleDiv.textContent = chat.name;

                const dateDiv = document.createElement('div');
                dateDiv.className = 'chat-menu-item-date';
                dateDiv.textContent = date + (chat.pdfFileName ? ' • ' + chat.pdfFileName.substring(0, 20) : '');

                item.appendChild(titleDiv);
                item.appendChild(dateDiv);

                // Add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '🗑️ Delete';
                deleteBtn.className = 'chat-menu-delete';
                deleteBtn.addEventListener('click', (e) => {
                    console.log('🔴 DELETE BUTTON CLICKED:', {
                        chatId: chat.id,
                        chatName: chat.name,
                        target: e.target
                    });
                    e.stopPropagation();
                    e.preventDefault();
                    deleteChat(chat.id, e);
                });
                item.appendChild(deleteBtn);

                // Click handler for the entire item
                item.addEventListener('click', (e) => {
                    console.log('🔵 ITEM CLICKED:', {
                        chatId: chat.id,
                        target: e.target,
                        isDeleteBtn: e.target === deleteBtn,
                        hasDeleteClass: e.target.classList.contains('chat-menu-delete')
                    });
                    // Only load chat if not clicking on delete button
                    if (e.target !== deleteBtn && !e.target.classList.contains('chat-menu-delete')) {
                        console.log('✅ Loading chat:', chat.id);
                        loadChat(chat.id);
                    } else {
                        console.log('⏭️ Skipping loadChat (delete button clicked)');
                    }
                });

                dropdown.appendChild(item);
            });
        }

        // Update current chat name display
        function updateCurrentChatName() {
            if (currentChatId && chats[currentChatId]) {
                document.getElementById('current-chat-name').textContent = chats[currentChatId].name;
            }
        }

        // Toggle chat menu
        function toggleChatMenu() {
            const dropdown = document.getElementById('chat-menu-dropdown');
            const btn = document.querySelector('.chat-menu-btn');

            // Calculate position dynamically
            const btnRect = btn.getBoundingClientRect();
            dropdown.style.top = `${btnRect.bottom + 8}px`;
            dropdown.style.left = `${btnRect.left}px`;

            dropdown.classList.toggle('show');

            // Prevent body scroll when dropdown is open
            if (dropdown.classList.contains('show')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Close chat menu
        function closeChatMenu() {
            document.getElementById('chat-menu-dropdown').classList.remove('show');
            document.body.style.overflow = '';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const chatMenu = document.getElementById('chat-menu-dropdown');
            const chatBtn = document.querySelector('.chat-menu-btn');
            const profileMenu = document.getElementById('profile-menu-dropdown');
            const profileBtn = document.querySelector('.profile-menu-btn');

            if (chatMenu && !chatMenu.contains(event.target) && !chatBtn.contains(event.target)) {
                closeChatMenu();
            }

            if (profileMenu && !profileMenu.contains(event.target) && !profileBtn.contains(event.target)) {
                closeProfileMenu();
            }
        });

        // 👤 PROFILE MENU SYSTEM

        // Toggle profile menu
        function toggleProfileMenu() {
            const dropdown = document.getElementById('profile-menu-dropdown');
            const btn = document.querySelector('.profile-menu-btn');

            // Calculate position dynamically
            const btnRect = btn.getBoundingClientRect();
            dropdown.style.top = `${btnRect.bottom + 8}px`;
            dropdown.style.right = '2rem';

            dropdown.classList.toggle('show');

            // Prevent body scroll when dropdown is open
            if (dropdown.classList.contains('show')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Close profile menu
        function closeProfileMenu() {
            document.getElementById('profile-menu-dropdown').classList.remove('show');
            document.body.style.overflow = '';
        }

        // Show account info
        function showAccountInfo() {
            closeProfileMenu();

            if (!currentUser) {
                alert('User not loaded');
                return;
            }

            const accountModal = document.createElement('div');
            accountModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;';

            const accountContent = document.createElement('div');
            accountContent.style.cssText = 'background:var(--dark-lighter);border:1px solid var(--glass-border);border-radius:20px;padding:2.5rem;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.3s ease;';

            const memberSince = new Date(currentUser.created_at).toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });

            const fullName = currentUser.user_metadata?.full_name || 'Not provided';

            accountContent.innerHTML = `
                <h2 style="margin:0 0 1.5rem 0;font-size:1.75rem;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Account Information</h2>
                <div style="display:flex;flex-direction:column;gap:1rem;">
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.25rem;">Full Name</div>
                        <div style="font-size:1rem;color:white;">${fullName}</div>
                    </div>
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.25rem;">Email</div>
                        <div style="font-size:1rem;color:white;">${currentUser.email}</div>
                    </div>
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.25rem;">User ID</div>
                        <div style="font-size:0.8rem;color:white;font-family:monospace;">${currentUser.id.substring(0, 24)}...</div>
                    </div>
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.25rem;">Account Status</div>
                        <div style="font-size:1rem;color:#10b981;">✓ Active</div>
                    </div>
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.25rem;">Member Since</div>
                        <div style="font-size:1rem;color:white;">${memberSince}</div>
                    </div>
                </div>
                <button onclick="this.closest('.modal-container').remove()" style="margin-top:1.5rem;width:100%;padding:0.875rem;background:var(--glass-bg);border:1px solid var(--glass-border);color:white;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;">Close</button>
            `;

            accountModal.className = 'modal-container';
            accountModal.appendChild(accountContent);
            document.body.appendChild(accountModal);

            accountModal.onclick = (e) => {
                if (e.target === accountModal) accountModal.remove();
            };
        }

        // Show billing & subscription
        function showBilling() {
            closeProfileMenu();

            const billingModal = document.createElement('div');
            billingModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;';

            const billingContent = document.createElement('div');
            billingContent.style.cssText = 'background:var(--dark-lighter);border:1px solid var(--glass-border);border-radius:20px;padding:2.5rem;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.3s ease;';

            billingContent.innerHTML = `
                <h2 style="margin:0 0 1.5rem 0;font-size:1.75rem;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Billing & Support</h2>
                <div style="display:flex;flex-direction:column;gap:1rem;">
                    <div style="background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(236,72,153,0.1));padding:1.5rem;border-radius:12px;border:1px solid var(--primary);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.5rem;">Current Plan</div>
                        <div style="font-size:1.5rem;color:white;font-weight:700;margin-bottom:0.25rem;">Free Trial</div>
                        <div style="font-size:0.9rem;color:rgba(255,255,255,0.7);">Full access to all features</div>
                    </div>
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.25rem;">Reports Generated</div>
                        <div style="font-size:1rem;color:white;">${Object.keys(chats).length} / ∞</div>
                    </div>
                    <button onclick="alert('Upgrade feature coming soon!')" style="margin-top:0.5rem;width:100%;padding:0.875rem;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;box-shadow:0 4px 15px rgba(99,102,241,0.4);">Upgrade to Pro</button>
                    <div style="height:1px;background:var(--glass-border);margin:0.5rem 0;"></div>
                    <a href="/support" target="_blank" style="width:100%;padding:0.875rem;background:var(--glass-bg);border:1px solid var(--glass-border);color:white;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;text-decoration:none;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
                        💬 Need Help? Visit Support Center
                    </a>
                </div>
                <button onclick="this.closest('.modal-container').remove()" style="margin-top:1.5rem;width:100%;padding:0.875rem;background:var(--glass-bg);border:1px solid var(--glass-border);color:white;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;">Close</button>
            `;

            billingModal.className = 'modal-container';
            billingModal.appendChild(billingContent);
            document.body.appendChild(billingModal);

            billingModal.onclick = (e) => {
                if (e.target === billingModal) billingModal.remove();
            };
        }

        // Show settings
        // 🔄 Recover report from jobId
        async function showRecoverReportDialog() {
            closeProfileMenu();

            const jobId = prompt('🔄 Enter your Report Job ID to recover your report:\n\n(The Job ID was provided when you started generating the report)');

            if (!jobId || jobId.trim() === '') return;

            try {
                const response = await fetch(`/recover-chat/${jobId.trim()}`);
                const data = await response.json();

                if (!response.ok) {
                    alert(`❌ ${data.error}\n\nThe report may have expired (older than 24h) or the Job ID is incorrect.`);
                    return;
                }

                // Create new chat with recovered data
                const newChatId = Date.now().toString();
                chats[newChatId] = {
                    id: newChatId,
                    name: `Recovered: ${data.pdfFileName.replace('.pdf', '')}`,
                    date: new Date().toISOString(),
                    messages: [
                        { text: `🔄 Report recovered from Job ID: ${jobId}`, sender: 'assistant' },
                        { text: `📄 File: ${data.pdfFileName}`, sender: 'assistant' }
                    ],
                    pdfContent: data.pdfContent,
                    pdfFileName: data.pdfFileName,
                    reportHtml: data.reportHtml,
                    reportFileName: data.reportFileName,
                    jobId: data.status === 'processing' ? jobId : null,
                    jobType: data.reportType
                };

                // Load the recovered chat
                currentChatId = newChatId;
                loadChat(newChatId);
                saveChatsToStorage();
                updateChatMenu();

                alert(`✅ Report recovered successfully!\n\nStatus: ${data.status}\nFile: ${data.pdfFileName}`);

            } catch (error) {
                console.error('Recovery error:', error);
                alert(`❌ Failed to recover report: ${error.message}`);
            }
        }

        function showSettings() {
            closeProfileMenu();

            const settingsModal = document.createElement('div');
            settingsModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;overflow-y:auto;';

            const settingsContent = document.createElement('div');
            settingsContent.style.cssText = 'background:var(--dark-lighter);border:1px solid var(--glass-border);border-radius:20px;padding:2.5rem;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.3s ease;margin:2rem auto;';

            settingsContent.innerHTML = `
                <h2 style="margin:0 0 1.5rem 0;font-size:1.75rem;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Settings</h2>
                <div style="display:flex;flex-direction:column;gap:1rem;">
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:0.95rem;color:white;margin-bottom:0.25rem;">Email Notifications</div>
                            <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);">Receive updates via email</div>
                        </div>
                        <input type="checkbox" checked style="width:20px;height:20px;cursor:pointer;">
                    </div>
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:0.95rem;color:white;margin-bottom:0.25rem;">Auto-save Reports</div>
                            <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);">Automatically save generated reports</div>
                        </div>
                        <input type="checkbox" checked style="width:20px;height:20px;cursor:pointer;">
                    </div>
                    <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                        <div style="font-size:0.8rem;color:rgba(255,255,255,0.5);margin-bottom:0.5rem;">Language</div>
                        <select style="width:100%;padding:0.5rem;background:var(--dark);border:1px solid var(--glass-border);border-radius:8px;color:white;cursor:pointer;">
                            <option>English</option>
                            <option>Français</option>
                            <option>Español</option>
                        </select>
                    </div>
                    <div style="height:1px;background:var(--glass-border);margin:0.5rem 0;"></div>
                    <button onclick="deleteAccount()" style="width:100%;padding:0.875rem;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#fca5a5;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
                        🗑️ Delete Account
                    </button>
                </div>
                <button onclick="this.closest('.modal-container').remove()" style="margin-top:1.5rem;width:100%;padding:0.875rem;background:var(--glass-bg);border:1px solid var(--glass-border);color:white;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;">Close</button>
            `;

            settingsModal.className = 'modal-container';
            settingsModal.appendChild(settingsContent);
            document.body.appendChild(settingsModal);

            settingsModal.onclick = (e) => {
                if (e.target === settingsModal) settingsModal.remove();
            };
        }

        // Logout function
        async function logout() {
            closeProfileMenu();

            if (confirm('Are you sure you want to logout?')) {
                // Sign out from Supabase
                await supabase.auth.signOut();

                // Clear local data
                localStorage.clear();

                // Redirect to auth page
                window.location.href = '/auth';
            }
        }

        // Delete account function
        function deleteAccount() {
            // Close all modals first
            const existingModals = document.querySelectorAll('.modal-container');
            existingModals.forEach(modal => modal.remove());

            const deleteModal = document.createElement('div');
            deleteModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:30000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;';

            const deleteContent = document.createElement('div');
            deleteContent.style.cssText = 'background:var(--dark-lighter);border:1px solid rgba(239,68,68,0.5);border-radius:20px;padding:2.5rem;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(239,68,68,0.3);animation:slideUp 0.3s ease;';

            deleteContent.innerHTML = `
                <h2 style="margin:0 0 1rem 0;font-size:1.75rem;color:#ef4444;">⚠️ Delete Account</h2>
                <div style="background:rgba(239,68,68,0.1);padding:1rem;border-radius:12px;border:1px solid rgba(239,68,68,0.3);margin-bottom:1.5rem;">
                    <p style="margin:0;color:#fca5a5;font-size:0.95rem;line-height:1.6;">This action is permanent and cannot be undone. All your data, including:</p>
                    <ul style="margin:0.5rem 0 0 1.5rem;color:#fca5a5;font-size:0.9rem;">
                        <li>Chat history</li>
                        <li>Generated reports</li>
                        <li>Account settings</li>
                        <li>User profile</li>
                    </ul>
                    <p style="margin:0.5rem 0 0 0;color:#fca5a5;font-size:0.95rem;">will be permanently deleted.</p>
                </div>
                <div style="margin-bottom:1.5rem;">
                    <label style="display:block;margin-bottom:0.5rem;color:rgba(255,255,255,0.9);font-size:0.9rem;">Type "DELETE" to confirm:</label>
                    <input type="text" id="delete-confirm-input" placeholder="DELETE" style="width:100%;padding:0.875rem;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:12px;color:white;font-size:1rem;">
                </div>
                <div style="display:flex;gap:1rem;">
                    <button onclick="this.closest('.modal-container').remove()" style="flex:1;padding:0.875rem;background:var(--glass-bg);border:1px solid var(--glass-border);color:white;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;">Cancel</button>
                    <button onclick="confirmDeleteAccount()" style="flex:1;padding:0.875rem;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;box-shadow:0 4px 15px rgba(239,68,68,0.4);">Delete Forever</button>
                </div>
            `;

            deleteModal.className = 'modal-container';
            deleteModal.appendChild(deleteContent);
            document.body.appendChild(deleteModal);

            deleteModal.onclick = (e) => {
                if (e.target === deleteModal) deleteModal.remove();
            };
        }

        // Confirm account deletion
        async function confirmDeleteAccount() {
            const input = document.getElementById('delete-confirm-input');

            if (input.value === 'DELETE') {
                try {
                    // Delete user from Supabase (requires backend function)
                    // For now, just sign out - full deletion requires admin API
                    await supabase.auth.signOut();

                    // Clear all local data
                    localStorage.clear();

                    // Close modal
                    const modal = document.querySelector('.modal-container');
                    if (modal) modal.remove();

                    // Redirect
                    window.location.href = '/auth';
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error deleting account. Please try again.');
                }
            } else {
                alert('Please type "DELETE" to confirm account deletion.');
                input.focus();
            }
        }

        // Auto-save every 30 seconds
        setInterval(saveChats, 30000);

        // Save before page unload
        window.addEventListener('beforeunload', saveChats);

        // Initialize on load
        window.addEventListener('load', initChatHistory);

        // 🔄 UNDO/REDO SYSTEM
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        // 🔄 HISTORY FUNCTIONS
        function saveToHistory(html, description) {
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }

            historyStack.push({
                html: html,
                description: description,
                timestamp: new Date().toLocaleTimeString()
            });

            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
            } else {
                historyIndex++;
            }

            updateUndoRedoButtons();
            console.log(`📚 History saved: ${description} (${historyIndex + 1}/${historyStack.length})`);
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                reportHtml = historyStack[historyIndex].html;

                const iframe = document.getElementById('preview-iframe');
                if (iframe) {
                    const blob = new Blob([reportHtml], { type: 'text/html' });
                    const url = window.URL.createObjectURL(blob);
                    iframe.src = url;
                }

                updateUndoRedoButtons();
                addMessage(`⏪ Undo: ${historyStack[historyIndex].description}`, 'assistant');
                console.log(`⏪ Undo to: ${historyStack[historyIndex].description}`);
            }
        }

        function redo() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                reportHtml = historyStack[historyIndex].html;

                const iframe = document.getElementById('preview-iframe');
                if (iframe) {
                    const blob = new Blob([reportHtml], { type: 'text/html' });
                    const url = window.URL.createObjectURL(blob);
                    iframe.src = url;
                }

                updateUndoRedoButtons();
                addMessage(`⏩ Redo: ${historyStack[historyIndex].description}`, 'assistant');
                console.log(`⏩ Redo to: ${historyStack[historyIndex].description}`);
            }
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');

            if (undoBtn) {
                undoBtn.disabled = historyIndex <= 0;
                undoBtn.title = historyIndex > 0 ? `Undo: ${historyStack[historyIndex - 1].description}` : 'No history';
            }

            if (redoBtn) {
                redoBtn.disabled = historyIndex >= historyStack.length - 1;
                redoBtn.title = historyIndex < historyStack.length - 1 ? `Redo: ${historyStack[historyIndex + 1].description}` : 'Nothing to redo';
            }

            const historyInfo = document.getElementById('history-info');
            if (historyInfo && historyStack.length > 0) {
                historyInfo.textContent = `${historyIndex + 1}/${historyStack.length}`;
            }
        }

        // ⌨️ KEYBOARD SHORTCUTS
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                if (historyIndex > 0) {
                    undo();
                }
            }
            else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                if (historyIndex < historyStack.length - 1) {
                    redo();
                }
            }
        });

        // PDF Upload
        document.getElementById('pdf-file').addEventListener('change', uploadPDF);

        async function uploadPDF() {
            const fileInput = document.getElementById('pdf-file');
            const file = fileInput.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('pdf', file);

            try {
                const response = await fetch('/api/upload-pdf', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    pdfContent = data.text;

                    // Update upload area
                    document.querySelector('.upload-area').classList.add('has-file');

                    // Show file info
                    document.getElementById('pdf-info').innerHTML = `
                        <strong>✓ ${file.name}</strong><br>
                        Pages: ${data.pages} | Characters: ${data.text.length.toLocaleString()}
                    `;
                    document.getElementById('pdf-info').style.display = 'block';

                    // Show config and generate sections
                    document.getElementById('config-section').style.display = 'flex';
                    document.getElementById('generate-section').style.display = 'flex';

                    addMessage('✓ PDF uploaded successfully! Configure your report and click Generate.', 'assistant');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Error uploading PDF');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            const sendBtn = document.getElementById('send-btn');
            const loading = document.getElementById('loading');

            sendBtn.disabled = true;
            loading.style.display = 'block';

            // Check if it's an edit command
            console.log('🔍 KEYWORD CHECK:', {
                message: message,
                hasReportHtml: !!reportHtml
            });

            if (reportHtml && (
                message.toLowerCase().includes('modifie') ||
                message.toLowerCase().includes('change') ||
                message.toLowerCase().includes('ajoute') ||
                message.toLowerCase().includes('supprime') ||
                message.toLowerCase().includes('delete') ||
                message.toLowerCase().includes('remove') ||
                message.toLowerCase().includes('recreate') ||
                message.toLowerCase().includes('regenerate') ||
                message.toLowerCase().includes('édite') ||
                message.toLowerCase().includes('remplace') ||
                message.toLowerCase().includes('couleur') ||
                message.toLowerCase().includes('color') ||
                message.toLowerCase().includes('section') ||
                message.toLowerCase().includes('gap') ||
                message.toLowerCase().includes('espace') ||
                message.toLowerCase().includes('expand') ||
                message.toLowerCase().includes('développe') ||
                message.toLowerCase().includes('résume') ||
                message.toLowerCase().includes('card') ||
                message.toLowerCase().includes('carte')
            )) {
                try {
                    addMessage('🔧 Analyzing your request...', 'assistant');

                    const response = await fetch('/api/chat-edit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            reportHtml: reportHtml,
                            pdfText: pdfContent
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (data.type === 'text_response') {
                            addMessage(data.message, 'assistant');
                        } else if (data.type === 'report_update') {
                            const change = data.changes[0];

                            if (change.instant) {
                                reportHtml = change.newHtml;
                                saveToHistory(reportHtml, change.message || 'Instant modification');
                                addMessage('✅ ' + data.message + ' (instant)', 'assistant');
                            } else {
                                addMessage('🤖 Generating content...', 'assistant');
                                reportHtml = change.newHtml;
                                saveToHistory(reportHtml, change.message || 'AI modification');
                                addMessage('✅ ' + data.message, 'assistant');
                            }

                            // Auto-refresh preview
                            const existingPreview = document.getElementById('preview-iframe');
                            if (existingPreview) {
                                existingPreview.style.opacity = '0.3';
                                const blob = new Blob([reportHtml], { type: 'text/html' });
                                const url = window.URL.createObjectURL(blob);
                                existingPreview.src = url;
                                setTimeout(() => {
                                    existingPreview.style.opacity = '1';
                                }, 200);
                            }
                        } else {
                            addMessage('❌ ' + (data.message || 'Modification failed'), 'assistant');
                        }
                    } else {
                        showError(data.error || data.details || 'Server error');
                    }
                } catch (error) {
                    console.error('Edit error:', error);
                    showError('Error modifying report: ' + error.message);
                } finally {
                    sendBtn.disabled = false;
                    loading.style.display = 'none';
                }
                return;
            }

            // Normal chat
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        pdfContent: pdfContent
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage(data.response, 'assistant');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Error communicating with server');
            } finally {
                sendBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Auto-save after new message
            if (currentChatId) {
                saveChats();
            }
        }

        function showError(errorMessage) {
            const messagesContainer = document.getElementById('chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = errorMessage;
            messagesContainer.appendChild(errorDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function generateReport() {
            if (!pdfContent) {
                showError('No PDF loaded to generate report');
                return;
            }

            const generateBtn = document.getElementById('generate-report-btn');
            const loading = document.getElementById('loading');
            const reportType = document.getElementById('report-type').value;
            const aiModel = document.getElementById('ai-model').value;

            generateBtn.disabled = true;
            loading.style.display = 'block';

            // Route to different generators based on report type
            if (aiModel === 'lovable') {
                return await generateLovableReport();
            }

            if (reportType === 'professional') {
                return await generateProfessionalReport();
            }

            try {
                generateBtn.textContent = '⏳ Generating...';
                addMessage('☕ Go grab a coffee, this will take a few minutes...', 'assistant');
                addMessage('📧 You can also come back later, we\'ll send you the report by email when it\'s ready!', 'assistant');

                // Get fileName from current chat or from file input
                const fileInput = document.getElementById('pdf-file');
                const fileName = (fileInput.files[0]?.name || chats[currentChatId]?.pdfFileName || 'report').replace('.pdf', '');

                // 🚀 Start async report generation
                const reportResponse = await fetch('/generate-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdfContent: pdfContent,
                        fileName: fileName,
                        reportType: reportType,
                        userEmail: currentUser?.email || null
                    })
                });

                const reportData = await reportResponse.json();

                if (!reportResponse.ok) {
                    throw new Error(reportData.error || 'Report generation error');
                }

                // Get jobId from response
                const jobId = reportData.jobId;
                console.log(`📡 Job started: ${jobId}`);

                // Show jobId to user for recovery
                addMessage(`🆔 Job ID: ${jobId}`, 'assistant');
                addMessage(`💾 Save this ID to recover your report later (Profile menu > Recover Report)`, 'assistant');

                // Save jobId to chat for recovery
                chats[currentChatId].jobId = jobId;
                chats[currentChatId].jobType = 'enhanced';
                saveChatsToStorage();

                // 🔄 Poll for completion
                await pollEnhancedReportStatus(jobId, generateBtn);

            } catch (error) {
                console.error('Error:', error);
                showError('❌ ' + error.message);
                generateBtn.textContent = '📊 Generate Report';
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // 🔄 Poll for Enhanced report generation status
        async function pollEnhancedReportStatus(jobId, generateBtn) {
            const pollInterval = 3000; // Check every 3 seconds
            let attempts = 0;
            const maxAttempts = 200; // 10 minutes max

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`/report-status/${jobId}`);

                    // Handle 404 - job not found (expired after 24h)
                    if (response.status === 404) {
                        delete chats[currentChatId].jobId;
                        delete chats[currentChatId].jobType;
                        saveChatsToStorage();

                        throw new Error('Report generation expired (older than 24h). Please generate a new report.');
                    }

                    const data = await response.json();

                    console.log(`📡 Job ${jobId} status:`, data.status);

                    if (data.status === 'completed') {
                        // ✅ Report ready!
                        reportHtml = data.reportHtml;
                        reportFileName = data.fileName;

                        // Clear jobId from chat
                        delete chats[currentChatId].jobId;
                        delete chats[currentChatId].jobType;
                        saveChatsToStorage();

                        // Save to history
                        saveToHistory(reportHtml, 'Initial report generated');

                        // Show action sections
                        document.getElementById('actions-section').style.display = 'flex';
                        document.getElementById('actions-divider').style.display = 'block';
                        document.getElementById('history-controls').style.display = 'block';

                        // 📚 Log documentation reminder
                        console.log('📚 View documentation - Click the "View Documentation" button to see all available editing commands!');

                        addMessage('✅ Your report is ready! You can preview or download it.', 'assistant');
                        addMessage('✨ Options available: Visual enhancement or conversion to presentation', 'assistant');
                        addMessage('🎯 Optional: Convert to presentation slides', 'assistant');

                        generateBtn.textContent = '✅ Report Generated';
                        return; // Done!

                    } else if (data.status === 'error') {
                        // ❌ Generation failed
                        delete chats[currentChatId].jobId;
                        delete chats[currentChatId].jobType;
                        saveChatsToStorage();

                        throw new Error(data.error || 'Report generation failed');

                    } else if (data.status === 'processing') {
                        // ⏳ Still processing, update UI with progress
                        const progress = data.progress || {};
                        const percentage = progress.percentage || 0;
                        const currentStep = progress.currentStep || 'Processing...';
                        const timeElapsed = `${Math.floor(attempts * 3 / 60)}m ${(attempts * 3) % 60}s`;

                        generateBtn.textContent = `⏳ ${currentStep} (${percentage}% - ${timeElapsed})`;
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                    // Don't break on network errors, keep trying
                }

                attempts++;
                await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            // Timeout reached
            throw new Error('Report generation timeout. Please check back later or contact support.');
        }

        // 💼 Professional Report Generator (DeepSeek with Academic Style)
        async function generateProfessionalReport() {
            const generateBtn = document.getElementById('generate-report-btn');
            const loading = document.getElementById('loading');

            try {
                generateBtn.textContent = '🎨 Generating Professional report...';
                addMessage('🎨 Generating professional report with DeepSeek...', 'assistant');
                addMessage('☕ Go grab a coffee, this will take a few minutes...', 'assistant');
                addMessage('📧 You can also come back later, we\'ll send you the report by email when it\'s ready!', 'assistant');
                addMessage('📊 Academic style with navigation, charts, and metrics', 'assistant');

                // Get fileName from current chat or from file input
                const fileInput = document.getElementById('pdf-file');
                const fileName = (fileInput.files[0]?.name || chats[currentChatId]?.pdfFileName || 'report').replace('.pdf', '');

                // 🚀 Start async report generation
                const response = await fetch('/generate-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdfContent: pdfContent,
                        fileName: fileName,
                        reportType: 'professional',
                        userEmail: currentUser?.email || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Professional report generation error');
                }

                // Get jobId from response
                const jobId = data.jobId;
                console.log(`📡 Job started: ${jobId}`);

                // Save jobId to chat for recovery
                chats[currentChatId].jobId = jobId;
                chats[currentChatId].jobType = 'professional';
                saveChatsToStorage();

                // 🔄 Poll for completion
                await pollReportStatus(jobId, generateBtn);

            } catch (error) {
                console.error('Professional report error:', error);
                showError('❌ ' + error.message);
                generateBtn.textContent = '📊 Generate Report';
            } finally {
                loading.style.display = 'none';
                generateBtn.disabled = false;
            }
        }

        // 🔄 Poll for report generation status
        async function pollReportStatus(jobId, generateBtn) {
            const pollInterval = 3000; // Check every 3 seconds
            let attempts = 0;
            const maxAttempts = 400; // 20 minutes max (400 * 3s = 1200s) - allows for 15min DeepSeek timeout + buffer

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`/report-status/${jobId}`);

                    // Handle 404 - job not found (expired after 24h)
                    if (response.status === 404) {
                        delete chats[currentChatId].jobId;
                        delete chats[currentChatId].jobType;
                        saveChatsToStorage();

                        throw new Error('Report generation expired (older than 24h). Please generate a new report.');
                    }

                    const data = await response.json();

                    console.log(`📡 Job ${jobId} status:`, data.status);

                    if (data.status === 'completed') {
                        // ✅ Report ready!
                        reportHtml = data.reportHtml;
                        reportFileName = data.fileName;

                        // Clear jobId from chat
                        delete chats[currentChatId].jobId;
                        delete chats[currentChatId].jobType;
                        saveChatsToStorage();

                        // Save to history
                        saveToHistory(reportHtml, 'Professional report generated');

                        // Show action sections
                        document.getElementById('actions-section').style.display = 'flex';
                        document.getElementById('actions-divider').style.display = 'block';
                        document.getElementById('history-controls').style.display = 'block';

                        addMessage('✅ Professional report generated successfully!', 'assistant');
                        addMessage('📊 Features: Sticky navigation, reading progress bar, charts, tables, animations', 'assistant');

                        generateBtn.textContent = '✅ Professional Report Ready';
                        return; // Done!

                    } else if (data.status === 'error') {
                        // ❌ Generation failed
                        delete chats[currentChatId].jobId;
                        delete chats[currentChatId].jobType;
                        saveChatsToStorage();

                        throw new Error(data.error || 'Report generation failed');

                    } else if (data.status === 'processing') {
                        // ⏳ Still processing, update UI with progress
                        const progress = data.progress || {};
                        const percentage = progress.percentage || 0;
                        const currentStep = progress.currentStep || 'Processing...';
                        const timeElapsed = `${Math.floor(attempts * 3 / 60)}m ${(attempts * 3) % 60}s`;

                        generateBtn.textContent = `⏳ ${currentStep} (${percentage}% - ${timeElapsed})`;
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                    // Don't break on network errors, keep trying
                }

                attempts++;
                await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            // Timeout reached
            throw new Error('Report generation timeout. Please check back later or contact support.');
        }

        function previewReport() {
            if (!reportHtml) {
                showError('No report to preview');
                return;
            }

            let previewContainer = document.getElementById('preview-container');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'preview-container';
                previewContainer.style.cssText = 'position:fixed;top:5%;left:5%;width:90%;height:90%;background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5);z-index:9999;display:flex;flex-direction:column;';

                const closeBtn = document.createElement('button');
                closeBtn.textContent = '✕';
                closeBtn.style.cssText = 'position:absolute;top:16px;right:16px;background:#ef4444;color:white;border:none;border-radius:12px;width:40px;height:40px;cursor:pointer;font-size:20px;z-index:10000;transition:all 0.2s;';
                closeBtn.onmouseover = () => closeBtn.style.background = '#dc2626';
                closeBtn.onmouseout = () => closeBtn.style.background = '#ef4444';
                closeBtn.onclick = () => previewContainer.style.display = 'none';

                const iframe = document.createElement('iframe');
                iframe.id = 'preview-iframe';
                iframe.style.cssText = 'width:100%;height:100%;border:none;border-radius:16px;';

                previewContainer.appendChild(closeBtn);
                previewContainer.appendChild(iframe);
                document.body.appendChild(previewContainer);
            }

            const iframe = document.getElementById('preview-iframe');
            const blob = new Blob([reportHtml], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            iframe.src = url;
            previewContainer.style.display = 'flex';
        }

        function downloadReport() {
            if (!reportHtml) {
                showError('No report to download');
                return;
            }

            const blob = new Blob([reportHtml], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = reportFileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addMessage('💾 Report downloaded successfully!', 'assistant');
        }

        async function convertToPresentation() {
            if (!reportHtml) {
                showError('No report to convert');
                return;
            }

            const convertBtn = document.getElementById('convert-presentation-btn');
            const loading = document.getElementById('loading');

            convertBtn.disabled = true;
            loading.style.display = 'block';

            try {
                convertBtn.textContent = '🎯 Converting to slides...';
                addMessage('🎯 Converting report to navigable presentation slides...', 'assistant');

                const presentationResponse = await fetch('/api/convert-to-presentation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reportHtml: reportHtml,
                        fileName: reportFileName
                    })
                });

                const presentationData = await presentationResponse.json();

                if (!presentationResponse.ok) {
                    throw new Error(presentationData.error || 'Presentation conversion error');
                }

                presentationHtml = presentationData.presentationHtml;
                presentationFileName = presentationData.fileName;

                addMessage('✅ Presentation created! Navigate with keyboard arrows', 'assistant');
                addMessage('🎯 Open HTML file to navigate between slides', 'assistant');

                document.getElementById('download-presentation-btn').style.display = 'block';
                convertBtn.textContent = '✅ Presentation Created';

            } catch (error) {
                console.error('Conversion error:', error);
                showError('❌ ' + error.message);
                convertBtn.textContent = '🎯 Convert to Presentation';
            } finally {
                convertBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function downloadPresentation() {
            if (!presentationHtml) {
                showError('No presentation to download');
                return;
            }

            const blob = new Blob([presentationHtml], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = presentationFileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            addMessage('🎞️ Presentation downloaded successfully! Open the HTML file in your browser.', 'assistant');
        }

        async function checkCredits() {
            try {
                addMessage('🔍 Checking API credits...', 'assistant');

                const response = await fetch('/api/check-credits');
                const data = await response.json();

                if (data.status === 'active') {
                    addMessage(`✅ ${data.message}`, 'assistant');
                    addMessage(`🔑 Key: ${data.keyStart}`, 'assistant');
                    addMessage(`🧠 Model tested: ${data.model_tested}`, 'assistant');
                } else if (data.status === 'no_credits') {
                    addMessage(`❌ ${data.message}`, 'assistant');
                    addMessage(`💡 Solution: ${data.solution}`, 'assistant');
                    addMessage(`🔗 Link: https://platform.deepseek.com`, 'assistant');
                } else if (data.status === 'rate_limited') {
                    addMessage(`⏳ ${data.message}`, 'assistant');
                    addMessage(`💡 ${data.error_detail}`, 'assistant');
                } else if (data.status === 'invalid_key') {
                    addMessage(`🔑 ${data.message}`, 'assistant');
                    addMessage(`💡 ${data.error_detail}`, 'assistant');
                } else {
                    addMessage(`❌ ${data.message}`, 'assistant');
                    addMessage(`📝 Detail: ${data.error_detail}`, 'assistant');
                }

            } catch (error) {
                addMessage('❌ Error checking credits', 'assistant');
                console.error('Credit check error:', error);
            }
        }

        async function generateLovableReport() {
            const generateBtn = document.getElementById('generate-report-btn');
            const loading = document.getElementById('loading');
            const reportType = document.getElementById('report-type').value;

            try {
                generateBtn.textContent = '🎨 Generating Lovable style...';
                addMessage('🎨 Generating a report with modern Lovable style...', 'assistant');

                const response = await fetch('/api/generate-lovable-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdfContent: pdfContent,
                        reportType: reportType
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Lovable generation error');
                }

                reportHtml = data.reportHtml;
                reportFileName = data.fileName;

                // Show action sections
                document.getElementById('actions-section').style.display = 'flex';
                document.getElementById('actions-divider').style.display = 'block';

                generateBtn.textContent = '✅ Lovable Report Created';
                addMessage('✅ Report with Lovable style generated successfully! Modern design with animations and gradients.', 'assistant');

            } catch (error) {
                console.error('Lovable error:', error);
                showError('Error generating Lovable style');
            } finally {
                loading.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = '📊 Generate Report';
            }
        }

        // 📚 Documentation popup
        function showCommandsDocumentation() {
            const docsModal = document.createElement('div');
            docsModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:30000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;overflow-y:auto;padding:2rem;';

            const docsContent = document.createElement('div');
            docsContent.style.cssText = 'background:var(--dark-lighter);border:1px solid var(--glass-border);border-radius:20px;padding:2.5rem;max-width:800px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.3s ease;max-height:90vh;overflow-y:auto;';

            docsContent.innerHTML = `
                <h2 style="margin:0 0 1.5rem 0;font-size:1.75rem;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">📚 Report Editing Commands</h2>

                <div style="background:rgba(99,102,241,0.1);padding:1rem;border-radius:12px;border:1px solid rgba(99,102,241,0.3);margin-bottom:1.5rem;">
                    <p style="margin:0;color:rgba(255,255,255,0.9);font-size:0.95rem;line-height:1.6;">
                        You can modify your generated report using natural language commands. Type your request in the chat to make instant or AI-powered changes.
                    </p>
                </div>

                <div style="display:flex;flex-direction:column;gap:2rem;">
                    <!-- Instant Modifications -->
                    <div>
                        <h3 style="font-size:1.25rem;color:var(--accent);margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                            ⚡ Instant Modifications
                        </h3>
                        <div style="display:flex;flex-direction:column;gap:0.75rem;">
                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Change Colors</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#10b981;">change color to blue</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Change the primary color of your report</div>
                            </div>

                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Delete Cards</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#10b981;">delete card [number]</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Remove a specific card from your report</div>
                            </div>

                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Delete Objects</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#10b981;">delete [section name]</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Remove a section by name</div>
                            </div>

                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Adjust Spacing</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#10b981;">reduce gap / increase espace</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Change spacing between elements</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI-Powered Changes -->
                    <div>
                        <h3 style="font-size:1.25rem;color:var(--secondary);margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
                            🤖 AI-Powered Changes
                        </h3>
                        <div style="display:flex;flex-direction:column;gap:0.75rem;">
                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Add Content</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#ec4899;">ajoute une section sur...</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Add new sections with AI-generated content</div>
                            </div>

                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Expand Sections</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#ec4899;">expand the [section] / développe...</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Make sections more detailed</div>
                            </div>

                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Summarize Content</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#ec4899;">résume la section / summarize...</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Make sections more concise</div>
                            </div>

                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Regenerate Sections</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#ec4899;">recreate / regenerate section...</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Generate new content for sections</div>
                            </div>

                            <div style="background:var(--glass-bg);padding:1rem;border-radius:12px;border:1px solid var(--glass-border);">
                                <div style="font-weight:600;color:white;margin-bottom:0.25rem;">Modify Content</div>
                                <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:6px;font-size:0.85rem;color:#ec4899;">modifie / change / remplace...</code>
                                <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">Make custom modifications to any part</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tips -->
                    <div style="background:rgba(245,158,11,0.1);padding:1rem;border-radius:12px;border:1px solid rgba(245,158,11,0.3);">
                        <h4 style="color:#fbbf24;margin-bottom:0.5rem;font-size:1rem;">💡 Tips</h4>
                        <ul style="margin:0;padding-left:1.5rem;color:rgba(255,255,255,0.8);font-size:0.9rem;line-height:1.8;">
                            <li>Commands work in both French and English</li>
                            <li>Use natural language - be specific about what you want</li>
                            <li>Preview changes instantly with the Preview button</li>
                            <li>Use Undo/Redo (Ctrl+Z / Ctrl+Y) to navigate changes</li>
                            <li>Instant changes are faster, AI changes are more creative</li>
                        </ul>
                    </div>
                </div>

                <button onclick="this.closest('.modal-container').remove()" style="margin-top:1.5rem;width:100%;padding:0.875rem;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.2s;box-shadow:0 4px 15px rgba(99,102,241,0.4);">Got it!</button>
            `;

            docsModal.className = 'modal-container';
            docsModal.appendChild(docsContent);
            document.body.appendChild(docsModal);

            docsModal.onclick = (e) => {
                if (e.target === docsModal) docsModal.remove();
            };
        }
    </script>
</body>
</html>
